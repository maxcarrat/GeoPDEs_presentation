% !TeX root = ../../../main.tex
\tikzexternaldisable%
\tikzset{%
	highlightStd/.style={rectangle,draw,semithick,inner sep=2.1pt, rounded corners, opacity=0.9,color=black%!50, fill=black!15,fill opacity=0.2
	}
}%
\tikzset{%
	highlight0/.style={rectangle,fill=black!15,draw,
		fill opacity=1,draw opacity=0.2,inner sep=0pt}
}%
\tikzset{%
	highlight1/.style={rectangle,fill=blue!15,draw,
		fill opacity=1,draw opacity=0.2,thin,inner sep=0pt}
}%
\tikzset{%
	highlight2/.style={rectangle,fill=orange!15,draw,
		fill opacity=1,draw opacity=0.2,thin,inner sep=0pt}
}%
\newcommand{\mytikzmark}[2]{%
	\tikz[overlay, remember picture, anchor=base, baseline=(#1.base), font=\scriptsize,  inner sep=0pt]%
	\node (#1) {#2};%
	%\tikzmark{#1}#2%
}%
%
\newcommand{\Highlight}[4][submatrix]{%
	%\tikz[overlay, remember picture]{
	\node[#2,fit=(#3.north west) (#4.south east), inner sep=1pt] (#1) {};%
	%}
}%
\newcommand{\AdjustRight}[2]{%
	%\tikz[overlay, remember picture, inner sep=0pt]{%
	\node[overlay, remember picture, inner sep=0pt] (#1adj) at (#2.east |- #1.south) {};%
	%}%
}%
\newcommand{\AdjustLeft}[2]{%
	%\tikz[overlay, remember picture, inner sep=0pt]{%
	\node[overlay, remember picture, inner sep=0pt] (#1adj) at ($(#2.west |- #1.north)+(0,-0.03)$) {};%
%	\node[overlay, remember picture, inner sep=0pt] (#1adj) at (#2 |- #1) {};%
	%}%
}%
%
%
\begin{tikzpicture}[remember picture]%
\node[remember picture] (R) at (0,0){%
$\begin{aligned}%
%\tensor{M}^{\glob}_2 &= & \frac{1}{16} &\left[\begin{smallmatrix} %
%\mytikzmark{left}{16} & 12 & 6 & 2 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0\\
%0 & 4 & 9 & 11 & 10 & 6 & 3 & 1 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0\\
%0 & 0 & 1 & 3 & 6 & 10 & 12 & 12 & 10 & 6 & \mytikzmark{leftE2}{3} & \mytikzmark{leftE3}{1} & 0 & 0 & 0 & 0 & 0 & 0\\
%0 & 0 & 0 & 0 & 0 & 0 & 1 & 3 & 6 & 10 & 9 & 3 & 0 & 0 & 0 & 0 & 0 & \mytikzmark{right}{0} \Highlight[second0]{highlight0}{left}{right}\\ 
%\mytikzmark{left}{0} & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 4 & 12 & 0 & 0 & 0 & 0 & 0 & \mytikzmark{right}{0}\Highlight[second1]{highlight1}{left}{right}\\
%\mytikzmark{left}{0} & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & \mytikzmark{leftE4}{16} & 0 & 0 & 0 & 0 & 0\\
%0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & \mytikzmark{leftE5}{16} & 0 & 0 & 0 & 0\\
%0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & \mytikzmark{rightE4}{16} & 0 & 0 & 0\\
%0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & \mytikzmark{rightE5}{16} & 0 & 0\\
%0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & \mytikzmark{rightE6}{16} & 0\\
%0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & \mytikzmark{rightE7}{16} \Highlight[second2]{highlight2}{left}{rightE7} %
%\end{smallmatrix}\right] \\%
%\Highlight[firstE4]{highlightStd}{leftE2}{leftE4}
%\Highlight[firstE4]{highlightStd}{leftE3}{leftE5}
%\Highlight[firstE4]{highlightStd}{leftE4}{rightE4}
%\Highlight[firstE5]{highlightStd}{leftE5}{rightE5}
%\Highlight[firstE6]{highlightStd}{rightE4}{rightE6}
%\Highlight[firstE7]{highlightStd}{rightE5}{rightE7}
\tensor{R}^{\superTHB 2,2}_{\epsilon_3} &= \tensor{I} &=   &&&\left[\begin{smallmatrix} %
\mytikzmark{left2}{1} & 0 & 0\\
0 & 1 & 0 \\
\mytikzmark{left2E3}{0} & 0 & \mytikzmark{right2}{1}
\end{smallmatrix}\right]\\%
\tensor{R}^{\superTHB 1,2}_{\epsilon_3} &= trunc(\tensor{R}^{1,2}_{\epsilon_3})  &= &&& \\ 
&= trunc(\frac{1}{16} \left[\begin{smallmatrix} %
12 & 4 & 0\\
4 & 12 & 12 \\
0 & 0 & 4
\end{smallmatrix}\right])&  =&\frac{1}{16} &&\left[\begin{smallmatrix} %
\mytikzmark{left1}{12} & 4 & 0\\
\mytikzmark{left1E3}{4} & 12 & \mytikzmark{right1E3}{0} \\
0 & 0 & \mytikzmark{right1}{0}
\end{smallmatrix}\right]\\%
\tensor{R}^{\superTHB 0,2}_{\epsilon_3} &=trunc(\tensor{R}^{0,1}_{\mathcal{Q}^1_5}) \cdot trunc(\tensor{R}^{1,2}_{\epsilon_3}) &&\\
%&= \frac{1}{16} \left[\begin{smallmatrix} %
%4 & 0 & 0\\
%12 & 0 & 0\\
%0 & 0 & 0\\
%\end{smallmatrix}\right]%
%\cdot%
%\tensor{R}^{\superTHB 1,2}_{\epsilon_3} %
&= trunc(\frac{1}{4} \left[\begin{smallmatrix} %
1 & 0 & 0\\
3 & 3 & 1\\
0 & 1 & 3\\
\end{smallmatrix}\right])%
\cdot%
\tensor{R}^{\superTHB 1,2}_{\epsilon_3}\\ %
&= \frac{1}{4} \left[\begin{smallmatrix} %
1 & 0 & 0\\
3 & 0 & 0\\
0 & 0 & 0\\
\end{smallmatrix}\right]%
\cdot%
\frac{1}{16} \left[\begin{smallmatrix} %
12 & 4 & 0\\
4 & 12 & 0 \\
0 & 0 & 0
\end{smallmatrix}\right]
&= & \frac{1}{16} &&\left[\begin{smallmatrix} %
\mytikzmark{left0}{3} & 1& 0 \\
9 & 3 & \mytikzmark{right0E3}{0}  \\
0 & 0 & \mytikzmark{right0}{0}
\end{smallmatrix}\right]%
\end{aligned}$};
%
\begin{pgfonlayer}{background}
\Highlight[first0]{highlight0}{left0}{right0}
\Highlight[first1]{highlight1}{left1}{right1}
\Highlight[first2]{highlight2}{left2}{right2}
%
\AdjustLeft{left1E3}{left1}
\Highlight[first0E3]{highlightStd}{left0}{right0E3} 
\Highlight[first1E3]{highlightStd}{left1E3adj}{right1E3}
\Highlight[first2E3]{highlightStd}{left2E3}{right2} 
\end{pgfonlayer}{background}
%
\node[remember picture, right=of R.east, anchor=west](M){
	$\begin{aligned}%
\mytikzmark{MLe4}{{\normalsize $\tensor{M}^{\loc}_{2,\epsilon_3}$}}  &&& \,= & \frac{1}{16} & \left[\begin{smallmatrix}
\mytikzmark{left0}{3} & 1 & 0    \\ 
9 & 3 & \mytikzmark{right0}{0} \\ 
\mytikzmark{left1}{4} & 12 & \mytikzmark{right1}{0} \\ 
\mytikzmark{left2}{0} & 0 & \mytikzmark{right2}{16} \\		
\end{smallmatrix}\,\right]  
\end{aligned}$};
\begin{pgfonlayer}{background}
\AdjustRight{right0}{right2}\AdjustRight{right1}{right2}\AdjustRight{right2}{right2}%
\Highlight[second0]{highlight0}{left0}{right0adj}
\Highlight[second1]{highlight1}{left1}{right1adj}
\Highlight[second2]{highlight2}{left2}{right2adj}
\end{pgfonlayer}{background}
%%
%%
%\tikz[overlay, remember picture] {
%  \draw[->,thick,red,dashed] (firstE0ne) -- (MLe0) node [] {};
%  \draw[->,thick,red,dashed] (firstE1se) -- (MLe1) node [] {};
%  \draw[->,thick,red,dashed] (firstE2se) -- (MLe2) node [] {};
% \draw[->,thick,red,dashed] (firstE3se) -- (MLe3) node [] {};
%}

\end{tikzpicture}
\tikzexternalenable